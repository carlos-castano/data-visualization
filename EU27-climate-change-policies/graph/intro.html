<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 360px;
            width: 360px;
            background-color: #f0f0f000;
            position: relative; 
            overflow: hidden; 
        }

        .tooltip {
            position: absolute;
            background-color: #dedede;
            border-radius: 8px;
            border-color: black;
            padding: 0;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            min-width: 150px;
        }

        .tooltip-header {
            padding: 8px;
            font-weight: bold;
            color: aliceblue;
            background-color: black;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }

        .tooltip-content {
            padding: 8px;
            background-color: #dedede;
            border-radius: 8px;
        }

        .tooltip-row {
            margin: 4px 0;
        }

        .icon {
            width: 40px;
            height: 40px;
        }
    </style>
</head>
<body>
    <div id="chart"></div>
    <div class="tooltip" id="tooltip"> 
        <div class="tooltip-header" id="tooltipHeader"></div>
        <div class="tooltip-content">
            <div class="tooltip-row"><strong>Mt CO2 eq:</strong> <em id="tooltipValue"></em></div>
            <div class="tooltip-row"><strong>Share:</strong> <em id="tooltipPercentage"></em></div>
        </div>
    </div>

    <script>
        const sectors = [
            { 'sector': 'Energy', 'value': 2603.85, 'percentage': 77.24, 'icon': 'icon/energy.png' },
            { 'sector': 'Industrial processes & product use', 'value': 291.84, 'percentage': 8.66, 'icon': 'icon/industry.png' },
            { 'sector': 'Agriculture', 'value': 365.72, 'percentage': 10.85, 'icon': 'icon/agriculture.png' },
            { 'sector': 'Waste management', 'value': 109.71, 'percentage': 3.25, 'icon': 'icon/waste.png' },
        ];

        const colors = {
            "Energy": "rgba(245, 241, 20, 0.5)",
            "Industrial processes & product use": "rgba(82, 80, 81, 0.5)",
            "Agriculture": "rgba(89, 237, 36, 0.5)",
            "Waste management": "rgba(101, 43, 237, 0.5)",
        };

        const borderColors = {
            "Energy": "rgba(245, 241, 20, 0.9)",
            "Industrial processes & product use": "rgba(82, 80, 81, 0.9)",
            "Agriculture": "rgba(89, 237, 36, 0.9)",
            "Waste management": "rgba(101, 43, 237, 0.9)",
        };

        const width = 350;
        const radius = width / 2;

        const svg = d3.select("#chart")
            .append("svg")
            .attr("width", width+1)
            .attr("height", width+1)
            .append("g")
            .attr("transform", `translate(${radius+0.5}, ${radius+0.5})`);

        const tooltip = d3.select("#tooltip");

        const arc = d3.arc()
            .innerRadius(radius / 2)
            .cornerRadius(2)
            .outerRadius(radius);

        const pie = d3.pie()
            .sort(null)
            .value(d => d.percentage);

        const arcs = svg.selectAll(".arc")
            .data(pie(sectors))
            .enter()
            .append("g")
            .attr("class", "arc");

        arcs.append("path")
            .attr("d", arc)
            .attr("fill", d => colors[d.data.sector])
            .attr("stroke", d => borderColors[d.data.sector])
            .attr("stroke-width", 2)
            .on("mouseover", function (event, d) {
                tooltip.style("opacity", 1)
                    .style("box-shadow", `0 2px 3px 3px ${borderColors[d.data.sector]}`);
                tooltip.select("#tooltipHeader")
                    .text(d.data.sector);
                tooltip.select("#tooltipValue").text(d.data.value.toFixed(2));
                tooltip.select("#tooltipPercentage").text(`${d.data.percentage.toFixed(2)}%`);
            })
            .on("mousemove", function (event) {
                // ----- INICIO DEL CÓDIGO MODIFICADO Y MEJORADO -----
                const [mouseX, mouseY] = d3.pointer(event, document.body);
                const tooltipNode = tooltip.node();
                const tooltipWidth = tooltipNode.offsetWidth;
                const tooltipHeight = tooltipNode.offsetHeight;
                
                const containerWidth = document.body.clientWidth;
                const containerHeight = document.body.clientHeight;
                const offset = 15; // Espacio entre el cursor y el tooltip

                // Posición por defecto: abajo y a la derecha
                let x = mouseX + offset;
                let y = mouseY + offset;

                // Si se sale por la derecha, lo ponemos a la izquierda del cursor
                if (x + tooltipWidth > containerWidth) {
                    x = mouseX - tooltipWidth - offset;
                }

                // Si se sale por abajo, lo ponemos arriba del cursor
                if (y + tooltipHeight > containerHeight) {
                    y = mouseY - tooltipHeight - offset;
                }

                // Ajuste final para que nunca se salga por la izquierda o por arriba
                if (x < 0) {
                    x = 0; // Pegar al borde izquierdo
                }
                if (y < 0) {
                    y = 0; // Pegar al borde superior
                }

                tooltip.style("left", `${x}px`).style("top", `${y}px`);
                // ----- FIN DEL CÓDIGO MODIFICADO -----
            })
            .on("mouseout", function () {
                tooltip.style("opacity", 0);
            })
            .attr("opacity", 0)
            .transition()
            .duration(1000)
            .attr("opacity", 1);

        svg.append("circle")
            .attr("cx", 0)
            .attr("cy", 0)
            .attr("r", radius / 2)
            .attr("fill", "#20202000");

        svg.append("text")
            .attr("x", 0)
            .attr("y", -10)
            .attr("text-anchor", "middle")
            .attr("fill", "#9e9e9e")
            .style("font-size", "18px")
            .style("font-weight", "bold")
            .text("EU 27 Source");

        svg.append("text")
            .attr("x", 0)
            .attr("y", 10)
            .attr("text-anchor", "middle")
            .attr("fill", "#9e9e9e")
            .style("font-size", "18px")
            .style("font-weight", "bold")
            .text("Emissions - 2022");

        arcs.append("image")
            .attr("xlink:href", d => d.data.icon)
            .attr("class", "icon")
            .attr("transform", function(d) {
                const [x, y] = arc.centroid(d);
                return `translate(${x - 20}, ${y - 20})`;
            })
            .attr("width", 40)
            .attr("height", 40)
            .attr("opacity", 0)
            .transition()
            .duration(1000)
            .attr("opacity", 1);
    </script>
</body>
</html>